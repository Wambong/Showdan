{% extends "base.html" %}

{% block title %}{{ e.name }} | Showdan{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-10 col-xl-9 app-screen">

    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h2 class="mb-1">{{ e.name }}</h2>
        <div class="text-white-50 small">
          Created by
          <span class="text-white fw-semibold">
            {{ e.created_by.first_name }} {{ e.created_by.last_name }}
          </span>
        </div>
      </div>

      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" href="{% url 'events:list' %}">Back</a>

        {% if is_creator %}
          <a class="btn btn-outline-light" href="{% url 'events:offers_inbox' %}?event={{ e.id }}">
            Offers
          </a>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-sm overflow-hidden">

      <div class="card-body">

        <!-- Status -->
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div class="text-white-50">Status</div>
          {% if e.is_locked %}
            <span class="badge bg-success">Locked (offer accepted)</span>
          {% else %}
            <span class="badge bg-secondary">Open</span>
          {% endif %}
        </div>

        {% if e.is_locked and accepted_pro %}
          <div class="d-flex align-items-center gap-3 p-3 rounded mb-3"
               style="background: rgba(255,255,255,0.06);">
            {% if accepted_pro_avatar %}
              <img src="{{ accepted_pro_avatar }}" class="rounded-circle" width="52" height="52" alt="Accepted professional">
            {% endif %}
            <div>
              <div class="text-white fw-semibold">
                Accepted professional:
                {{ accepted_pro.first_name }} {{ accepted_pro.last_name }}
              </div>
              <div class="text-white-50 small">
                This event is locked for new offers, but the accepted thread can continue chatting.
              </div>
            </div>
          </div>
        {% endif %}

        <!-- When -->
        <div class="row g-3">
          <div class="col-md-6">
            <div class="text-white-50 small mb-1">Start</div>
            <div class="text-white fw-semibold">
              {% if start_local %}{{ start_local|date:"d M Y • H:i" }}{% else %}-{% endif %}
            </div>
          </div>

          <div class="col-md-6">
            <div class="text-white-50 small mb-1">End</div>
            <div class="text-white fw-semibold">
              {% if end_local %}{{ end_local|date:"d M Y • H:i" }}{% else %}-{% endif %}
            </div>
          </div>
        </div>

        <hr class="my-4">

        <!-- Location + Type -->
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <div class="text-white-50 small mb-1">Location</div>
            <div class="text-white fw-semibold">
              {% if e.location %}{{ e.location }}{% else %}-{% endif %}
            </div>

            {% if e.location %}
              <div class="mt-2">
                <a class="small text-decoration-none"
                   target="_blank"
                   rel="noopener"
                   href="https://www.google.com/maps?q={{ e.location|urlencode }}">
                  View on Google Maps →
                </a>
              </div>
            {% endif %}
          </div>

          <div class="col-md-6">
            <div class="text-white-50 small mb-1">Event type</div>
            <div class="text-white fw-semibold">
              {% if e.event_type %}{{ e.event_type.name }}{% else %}Event{% endif %}
            </div>
          </div>
        </div>

      </div>

      <!-- BIG MAP (edge-to-edge inside card) -->
      {% if e.location %}
        <div class="px-0">
          <iframe
            title="Event location map"
            class="event-map-iframe"
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
            src="https://www.google.com/maps?q={{ e.location|urlencode }}&output=embed">
          </iframe>
        </div>
      {% endif %}

      <div class="card-body">

        <hr class="my-4">

        <!-- Professions -->
        <div class="mb-3">
          <div class="text-white-50 small mb-2">Required professions</div>
          {% if e.required_professions.all %}
            <div class="d-flex flex-wrap gap-2">
              {% for p in e.required_professions.all %}
                {% if not p.children.exists %}
                  <span class="badge bg-light text-dark border">{{ p.name }}</span>
                {% endif %}
              {% endfor %}
            </div>
          {% else %}
            <div class="text-white-50">No professions selected.</div>
          {% endif %}
        </div>

        <hr class="my-4">

        <!-- Pricing -->
        <div class="mb-3">
          <div class="text-white-50 small mb-2">Budget</div>

          {% if e.currency %}
            <div class="d-flex justify-content-between">
              <div class="text-white-50">Event budget</div>
              <div class="text-white fw-semibold">
                {{ e.currency.sign }}{{ e.event_budget|default:"-" }}
              </div>
            </div>

            <div class="d-flex justify-content-between mt-2">
              <div class="text-white-50">Advance payment</div>
              <div class="text-white fw-semibold">
                {{ e.currency.sign }}{{ e.advance_payment|default:"-" }}
              </div>
            </div>
          {% else %}
            <div class="text-white-50">No currency set.</div>
          {% endif %}
        </div>

        <hr class="my-4">

        <!-- Actions -->
        <div class="d-flex gap-2">
          {% if is_pro and not is_creator %}
            {% if e.is_locked %}
              <button class="btn btn-secondary w-100" disabled>
                Event locked (offers closed)
              </button>
            {% else %}
              <a class="btn btn-primary w-100" href="{% url 'events:offers_inbox' %}?event={{ e.id }}">
                Make offer
              </a>
            {% endif %}
          {% endif %}

          {% if is_creator %}
            <a class="btn btn-outline-light w-100" href="{% url 'events:offers_inbox' %}?event={{ e.id }}">
              View offer threads
            </a>
          {% endif %}
        </div>

      </div>
    </div>

  </div>
</div>
{% endblock %}
