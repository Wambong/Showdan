{% extends "base.html" %}
{% load static %}
{% load account_extras %}
{% load i18n %}
{% block title %}{{ prof.first_name }} {{ prof.last_name }} | Showdan{% endblock %}

{% block content %}
<div class="profile-detail-wrap mx-auto">

  <!-- Header -->
<div class="profile-topbar d-flex align-items-center justify-content-between mb-3">
  <a class="btn btn-sm btn-outline-light" href="{% url 'home' %}">‚Üê {% translate "Back" %}</a>
  <div class="profile-top-title">{% translate "Artist profile" %}</div>

  <div class="d-flex gap-2">

    {% if request.user.is_authenticated %}
      <div id="favBtnWrap">
        <form method="post"
              action="{% url 'accounts:favorite_toggle' prof.id %}"
              hx-post="{% url 'accounts:favorite_toggle' prof.id %}"
              hx-target="#favBtnWrap"
              hx-swap="outerHTML">
          {% csrf_token %}
          <button
            class="btn btn-sm btn-outline-light"
            type="submit"
            aria-label="Toggle favorite"
            {% if is_favorite %}style="color:#ff4d4f; border-color:#ff4d4f;"{% endif %}
          >
            {% if is_favorite %}‚ô•{% else %}‚ô°{% endif %}
          </button>

        </form>
      </div>
    {% else %}
      <a class="btn btn-sm btn-outline-light" href="{% url 'accounts:login' %}">{% translate "Login" %}</a>
    {% endif %}

  </div>
</div>

  <!-- Main card -->
  <div class="profile-hero text-center mb-3">
    <div class="profile-photo">
      <img src="{{ prof.profile_picture.url }}" alt="{{ prof.first_name }}">
      <div class="profile-badge">
        ‚òÖ {{ avg_rating|floatformat:1 }}
      </div>
    </div>

    <h4 class="mt-3 mb-1">{{ prof.first_name }} {{ prof.last_name }}</h4>

    {% if prof.professions.exists %}
      <div class="text-white-50 small">
        {% for p in prof.professions.all %}
          <span class="me-1">{{ p.name }}</span>{% if not forloop.last %}‚Ä¢{% endif %}
        {% endfor %}
      </div>
    {% else %}
      <div class="text-white-50 small">{% translate "Professional" %}</div>
    {% endif %}
  </div>

  <!-- Tabs -->
  <div class="profile-tabs mb-4">
    <a class="profile-tab {% if tab != 'calendar' %}active{% endif %}"
       href="?tab=overview">
      {% translate "Overview" %}
    </a>

    <a class="profile-tab {% if tab == 'calendar' %}active{% endif %}"
       href="?tab=calendar">
      {% translate "Calendar" %}
    </a>
  </div>

  {% if tab == "calendar" %}

    <!-- =======================
         CALENDAR TAB (READ ONLY)
    ======================== -->
    <div class="calendar-wrap mx-auto">

      <div class="calendar-head">
        <a class="cal-nav" href="?tab=calendar&year={{ prev_year }}&month={{ prev_month }}">‚Äπ</a>
        <div class="cal-title">
          <div class="text-white fw-bold">{% translate "Availability" %}</div>
          <div class="text-white-50 small">{{ month_name }}, {{ year }}</div>
        </div>
        <a class="cal-nav" href="?tab=calendar&year={{ next_year }}&month={{ next_month }}">‚Ä∫</a>
      </div>

      <div class="calendar-grid">
        <div class="cal-dow">{% translate "Mon" %}</div><div class="cal-dow">{% translate "Tue" %}</div><div class="cal-dow">{% translate "Wed" %}</div>
        <div class="cal-dow">{% translate "Thu" %}</div><div class="cal-dow">{% translate "Fri" %}</div><div class="cal-dow">{% translate "Sat" %}</div><div class="cal-dow">{% translate "Sun" %}</div>

        {% for week in weeks %}
          {% for d in week %}
          {% with booked=booked_map|get_item:d busy=busy_map|get_item:d %}
              <div
                role="button"
                tabindex="0"
                class="cal-day cal-day-click
                       {% if is_past %}is-past{% endif %}
                       {% if d.month != month %}is-out{% endif %}
                       {% if d == today %}is-today{% endif %}
                       {% if booked %}is-booked{% endif %}
                       {% if busy %}is-busy{% endif %}"
                data-date="{{ d|date:'Y-m-d' }}"
                data-is-past="{% if d < today %}1{% else %}0{% endif %}"
                data-date-label="{{ d|date:'d M Y' }}"
                data-booked='[{% if booked %}{% for r in booked.ranges %}
                    {
                      "event_id": {{ r.event_id }},
                      "name":"{{ r.name|escapejs }}",
                      "label":"{{ r.label|default_if_none:""|escapejs }}",
                      "is_locked": {{ r.is_locked|yesno:"true,false" }},
                      "accepted_name":"{{ r.accepted_name|default_if_none:""|escapejs }}",
                      "accepted_avatar":"{{ r.accepted_avatar|default_if_none:""|escapejs }}"
                    }{% if not forloop.last %},{% endif %}
                  {% endfor %}{% endif %}]'
                data-busy='[{% if busy %}{% for b in busy %}{"all_day":{{ b.is_all_day|yesno:"true,false" }},"start":"{{ b.start|escapejs }}","end":"{{ b.end|escapejs }}","note":"{{ b.note|default_if_none:""|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}{% endif %}]'
                {% if booked and avatar_url %}
                  style="--avatar-url: url('{{ avatar_url }}');"
                {% endif %}
              >
                <div class="cal-day-num">{{ d.day }}</div>

                {% if booked %}
                  <div class="cal-bars">
                    {% for r in booked.ranges %}
                      <div class="cal-bar {% if r.is_start %}is-start{% endif %}{% if r.is_end %} is-end{% endif %}">
                        <span class="cal-bar-title">{{ r.name }}</span>
                        {% if r.label %}<span class="cal-bar-time">{{ r.label }}</span>{% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}

                {% if busy %}
                  <div class="cal-busy-dot"></div>
                {% endif %}
              </div>
          {% endwith %}

          {% endfor %}
        {% endfor %}
      </div>


<!-- Calendar details modal (read-only) -->
<div class="modal fade" id="calDayModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" style="background:#0f1218; border:1px solid rgba(255,255,255,0.08); border-radius:16px;">
      <div class="modal-header" style="border-bottom:1px solid rgba(255,255,255,0.08);">
        <h5 class="modal-title text-white" id="calDayModalTitle">{% translate "Day details" %}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="text-white-50 small mb-3" id="calDayModalSub"></div>

        <div class="mb-3" id="calModalBookedWrap" style="display:none;">
          <div class="text-white fw-semibold mb-2">{% translate "Booked events" %}</div>
          <div id="calModalBookedList" class="d-flex flex-column gap-2"></div>
        </div>

        <div class="mb-2" id="calModalBusyWrap" style="display:none;">
          <div class="text-white fw-semibold mb-2">{% translate "Unavailable" %}</div>
          <div id="calModalBusyList" class="d-flex flex-column gap-2"></div>
        </div>

        <div class="text-white-50 text-center py-4" id="calModalEmpty" style="display:none;">
          {% translate "No events or unavailable times for this day" %}.
        </div>

        <!-- CTA area: only shown on free days -->
        <div class="mt-3" id="calModalCTA" style="display:none;">
          <hr style="border-color: rgba(255,255,255,0.08);">

          <div class="text-white fw-semibold mb-2">{% translate "Request booking" %}</div>
          <div class="text-white-50 small mb-2">{% translate "Pick a time range for this day" %}.</div>

          <div class="row g-2">
            <div class="col-6">
              <label class="form-label text-white-50 small mb-1">{% translate "Start time" %}</label>
              <div class="d-flex gap-2">
                <select id="calOfferStartHour" class="form-select form-select-sm"></select>
                <select id="calOfferStartMin" class="form-select form-select-sm">
                  <option value="00">00</option><option value="15">15</option>
                  <option value="30">30</option><option value="45">45</option>
                </select>
              </div>
            </div>

            <div class="col-6">
              <label class="form-label text-white-50 small mb-1">{% translate "End time" %}</label>
              <div class="d-flex gap-2">
                <select id="calOfferEndHour" class="form-select form-select-sm"></select>
                <select id="calOfferEndMin" class="form-select form-select-sm">
                  <option value="00">00</option><option value="15">15</option>
                  <option value="30">30</option><option value="45">45</option>
                </select>
              </div>
            </div>
          </div>

          <div class="text-danger small mt-2" id="calOfferErr" style="display:none;"></div>

          <a id="calModalMakeOfferBtn" class="btn btn-primary w-100 mt-2" href="#">
            {% translate "Make offer" %}
          </a>
        </div><!-- /#calModalCTA -->

      </div><!-- /.modal-body -->
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /#calDayModal -->


  {% else %}

  <!-- =======================
         OVERVIEW TAB (YOUR ORIGINAL PAGE)
  ======================== -->

  <!-- About -->
  <div class="profile-section">
    <div class="section-title">{% translate "About me" %}</div>
    {% if prof.about_me %}
      <div class="section-text" style="white-space: pre-line;">{{ prof.about_me }}</div>
    {% else %}
      <div class="section-muted">{% translate "No description yet" %}.</div>
    {% endif %}
  </div>

  <!-- Languages -->
  <div class="profile-section">
    <div class="section-title d-flex align-items-center justify-content-between">
      <span>{% translate "Languages" %}</span>
      <span class="section-icon">i</span>
    </div>

    <div class="section-subtitle">{% translate "Communication" %}</div>
    <div class="chip-row">
      {% for l in prof.communication_languages.all %}
        <span class="chip">{{ l.name }}</span>
      {% empty %}
        <span class="section-muted">{% translate "None selected" %}</span>
      {% endfor %}
    </div>

    <div class="section-subtitle mt-3">{% translate "Event language" %}</div>
    <div class="chip-row">
      {% for l in prof.event_languages.all %}
        <span class="chip">{{ l.name }}</span>
      {% empty %}
        <span class="section-muted">{% translate "None selected" %}</span>
      {% endfor %}
    </div>
  </div>

  <!-- Accepted event categories -->
  <div class="profile-section">
    <div class="section-title d-flex align-items-center justify-content-between">
      <span>{% translate "Accepted event categories" %}</span>
      <span class="section-icon">i</span>
    </div>

    <div class="chip-row">
      {% for c in prof.accepted_event_categories.all %}
        <span class="chip chip-soft">{{ c }}</span>
      {% empty %}
        <span class="section-muted">{% translate "No accepted categories selected" %}.</span>
      {% endfor %}
    </div>
  </div>

  <!-- Pricing -->
  <div class="profile-section">
    <div class="section-title">{% translate "Pricing" %}</div>

    {% if prof.currency %}
      <div class="pricing-row">
        <div class="pricing-item">
          <div class="pricing-label">{% translate "Cost per hour" %}</div>
          <div class="pricing-val">{{ prof.currency.sign }}{{ prof.cost_per_hour|default:"‚Äî" }}</div>
        </div>
        <div class="pricing-item">
          <div class="pricing-label">{% translate "Cost per 5 hours" %}</div>
          <div class="pricing-val">{{ prof.currency.sign }}{{ prof.cost_per_5_hours|default:"‚Äî" }}</div>
        </div>
      </div>
    {% else %}
      <div class="section-muted">{% translate "No pricing set" %}.</div>
    {% endif %}
  </div>

  <!-- Studio photos -->
  <div class="profile-section">
    <div class="section-title">{% translate "Studio photos" %}</div>

    <div class="media-grid">
      {% for ph in professional_photos|slice:":4" %}
        <div class="media-thumb">
          <img src="{{ ph.image.url }}" alt="Studio photo">
        </div>
      {% empty %}
        <div class="section-muted">{% translate "No photos uploaded yet" %}.</div>
      {% endfor %}
    </div>

    {% if professional_photos|length > 4 %}
      <a class="btn btn-sm btn-outline-light w-100 mt-2"
         href="{% url 'accounts:profile_media' prof.id %}?tab=studio">
        {% translate "View all studio photos" %} ({{ professional_photos|length }})
      </a>
    {% endif %}
  </div>

  <!-- Live photos -->
  <div class="profile-section">
    <div class="section-title">{% translate "Live / work photos" %}</div>

    <div class="media-grid">
      {% for ph in normal_photos|slice:":4" %}
        <div class="media-thumb">
          <img src="{{ ph.image.url }}" alt="Work photo">
        </div>
      {% empty %}
        <div class="section-muted">{% translate "No photos uploaded yet" %}.</div>
      {% endfor %}
    </div>

    {% if normal_photos|length > 4 %}
      <a class="btn btn-sm btn-outline-light w-100 mt-2"
         href="{% url 'accounts:profile_media' prof.id %}?tab=work">
        {% translate "View all work photos" %} ({{ normal_photos|length }})
      </a>
    {% endif %}
  </div>

  <!-- Audio -->
  <div class="profile-section">
    <div class="section-title">{% translate "Audio performances" %}</div>

    <div class="media-list">
      {% for a in audio_covers|slice:":4" %}
        <div class="audio-row">
          <div class="audio-dot">‚ô™</div>
          <div class="audio-meta">
            <div class="audio-name">{% translate "Audio cover" %} {{ forloop.counter }}</div>
            <div class="audio-sub">{% translate "Tap to play" %}</div>
          </div>
          <audio controls preload="none" class="audio-player">
            <source src="{{ a.audio_file.url }}">
          </audio>
        </div>
      {% empty %}
        <div class="section-muted">{% translate "No audio uploaded yet" %}.</div>
      {% endfor %}
    </div>

    {% if audio_covers|length > 4 %}
      <a class="btn btn-sm btn-outline-light w-100 mt-2"
         href="{% url 'accounts:profile_media' prof.id %}?tab=audio">
        {% translate "View all audio" %} ({{ audio_covers|length }})
      </a>
    {% endif %}
  </div>

  <!-- Video -->
  <div class="profile-section">
    <div class="section-title">{% translate "Video performances" %}</div>

    <div class="media-list">
      {% for v in video_covers|slice:":4" %}
        <div class="video-row">
          <video controls preload="none" class="video-player">
            <source src="{{ v.video_file.url }}">
          </video>
        </div>
      {% empty %}
        <div class="section-muted">{% translate "No videos uploaded yet" %}.</div>
      {% endfor %}
    </div>

    {% if video_covers|length > 4 %}
      <a class="btn btn-sm btn-outline-light w-100 mt-2"
         href="{% url 'accounts:profile_media' prof.id %}?tab=video">
        {% translate "View all videos" %} ({{ video_covers|length }})
      </a>
    {% endif %}
  </div>

  <!-- Reviews -->
  <div class="profile-section">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="section-title mb-0">{% translate "Reviews" %} ({{ review_count }})</div>
    </div>

    {% if can_review %}
      {% if existing_review %}
        <div class="section-muted mb-3">
          {% translate "You already reviewed this profile" %}.
        </div>
      {% elif review_form %}
        <form method="post" action="{% url 'accounts:create_review' prof.id %}" class="review-form mb-3">
          {% csrf_token %}

          <div class="mb-2">
            <label class="form-label">{% translate "Rating" %}</label>
            {{ review_form.rating }}
            {% if review_form.rating.errors %}
              <div class="text-danger small mt-1">{{ review_form.rating.errors }}</div>
            {% endif %}
          </div>

          <div class="mb-2">
            <label class="form-label">{% translate "Comment" %}</label>
            {{ review_form.comment }}
            {% if review_form.comment.errors %}
              <div class="text-danger small mt-1">{{ review_form.comment.errors }}</div>
            {% endif %}
          </div>

          <button type="submit" class="btn btn-sm btn-outline-light w-100">{% translate "Submit review" %}</button>
        </form>
      {% endif %}
    {% endif %}

    {% for r in reviews %}
      <div class="review-card mb-3">
        <div class="review-head">
          <div class="review-user">
            <div class="review-avatar">
              <img src="{{ r.reviewer.profile_picture.url }}" alt="{{ r.reviewer.first_name }}">
            </div>
            <div class="review-meta">
              <div class="review-name">{{ r.reviewer.first_name }} {{ r.reviewer.last_name }}</div>
              <div class="review-date">{{ r.created_at|date:"d M Y ‚Ä¢ H:i" }}</div>
            </div>
          </div>

          <div class="review-rating" aria-label="{{ r.rating }} out of 5">
            {% for i in "12345" %}
              {% if forloop.counter <= r.rating %}
                <span class="star filled">‚òÖ</span>
              {% else %}
                <span class="star">‚òÖ</span>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        {% if r.comment %}
          <p class="review-text mb-0" style="white-space: pre-line;">{{ r.comment }}</p>
        {% else %}
          <p class="review-text mb-0 text-white-50">{% translate "No comment" %}.</p>
        {% endif %}
      </div>
    {% empty %}
      <div class="section-muted">{% translate "No reviews yet" %}.</div>
    {% endfor %}
  </div>

  {% endif %}
        <!-- =======================
       SIMILAR PROFESSIONALS
  ======================== -->
  <div class="profile-section">
    <div class="section-title">{% translate "Similar professionals" %}</div>

    {% if pros %}
      <div class="row g-3">
        {% for u in pros %}
          <div class="col-6 col-md-3">
            <a class="text-decoration-none" href="{% url 'accounts:profile_detail' u.id %}">
              <div class="pro-card">
                <div class="pro-card-media">

                  {# ‚úÖ FIXED: correct images #}
                  {% if u.profile_picture %}
                    <img src="{{ u.profile_picture.url }}" alt="{{ u.first_name }}">
                  {% elif u.professional_picture %}
                    <img src="{{ u.professional_picture.url }}" alt="{{ u.first_name }}">

                  {% else %}
                    <div class="pro-card-fallback"></div>
                  {% endif %}

                  <div class="pro-rating">
                    <span class="pro-rating-star">‚òÖ</span>
                    <span class="pro-rating-val">
                      {% if u.review_count > 0 %}
                        {{ u.avg_rating|floatformat:1 }}
                      {% else %}
                        {% translate "New" %}
                      {% endif %}
                    </span>
                  </div>

                  <div class="pro-price">
                    {% if u.currency and u.cost_per_hour %}
                      {{ u.currency.sign }} {{ u.cost_per_hour|floatformat:0 }}
                    {% else %}
                      {% translate "From" %} ‚Äî
                    {% endif %}
                  </div>
                </div>

                <div class="pro-card-body">
                  <div class="pro-name">{{ u.first_name }} {{ u.last_name }}</div>

                  <div class="pro-sub">
                    {% with p=u.professions.first %}
                      {% if p %}
                        <span class="pro-icon">üé§</span> {{ p.name }}
                      {% else %}
                        <span class="pro-icon">üé§</span> {% translate "Professional" %}
                      {% endif %}
                    {% endwith %}
                  </div>

                  {# Optional location line #}
                  {% if u.city or u.country %}
                    <div class="text-white-50 small mt-1">
                      {{ u.city }}{% if u.city and u.country %}, {% endif %}{{ u.country }}
                    </div>
                  {% endif %}
                </div>
              </div>
            </a>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-white-50 mb-0">{% translate "No similar professionals yet" %}.</p>
    {% endif %}
  </div>


</div>

<script>
  window.PUBLIC_CAL_BOOKING_URL = "{% url 'events:booking_request_calendar' prof.id %}";
</script>

{% endblock %}
