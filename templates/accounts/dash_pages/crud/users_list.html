{% load i18n %}
<div>
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h3 class="text-white mb-0">{% translate "Users" %}</h3>
      <div class="text-white-50 small">{% translate "Manage accounts (staff only)" %}</div>
    </div>

    <a class="btn btn-outline-light btn-sm"
       href="{% url 'accounts:dash_crud_home' %}"
       hx-get="{% url 'accounts:dash_crud_home' %}"
       hx-target="#dashMainCard" hx-swap="innerHTML" hx-push-url="true">
      {% translate "Back" %}
    </a>
  </div>

  <!-- Filters -->
  <form class="row g-2 mb-3"
        method="get"
        action="{% url 'accounts:dash_crud_users_list' %}"
        hx-get="{% url 'accounts:dash_crud_users_list' %}"
        hx-target="#dashMainCard"
        hx-swap="innerHTML"
        hx-push-url="true">

    <div class="col-12 col-lg-5">
      <input type="text"
             name="q"
             value="{{ q }}"
             class="form-control form-control-sm"
             placeholder="Search by name, email, nickname, phone…">
    </div>

    <div class="col-6 col-lg-2">
      <select name="type" class="form-select form-select-sm">
        <option value="">{% translate "All types" %}</option>
        <option value="personal" {% if account_type == "personal" %}selected{% endif %}>{% translate "Personal" %}</option>
        <option value="professional" {% if account_type == "professional" %}selected{% endif %}>{% translate "Professional" %}</option>
      </select>
    </div>

    <div class="col-6 col-lg-2">
      <select name="staff" class="form-select form-select-sm">
        <option value="">{% translate "All roles</option>
        <option value="1" {% if staff == "1" %}selected{% endif %}>{% translate "Staff" %}</option>
        <option value="0" {% if staff == "0" %}selected{% endif %}>{% translate "Not staff" %}</option>
      </select>
    </div>

    <div class="col-6 col-lg-2">
      <select name="active" class="form-select form-select-sm">
        <option value="">{% translate "All statuses" %}</option>
        <option value="1" {% if active == "1" %}selected{% endif %}>{% translate "Active" %}</option>
        <option value="0" {% if active == "0" %}selected{% endif %}>{% translate "Inactive" %}</option>
      </select>
    </div>

    <div class="col-6 col-lg-1 d-grid">
      <button class="btn btn-primary btn-sm" type="submit">{% translate "Go" %}</button>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-dark table-striped align-middle">
      <thead>
        <tr>
          <th>{% translate "User" %}</th>
          <th>{% translate "Email" %}</th>
          <th>{% translate "Type" %}</th>
          <th>{% translate "Staff" %}</th>
          <th>{% translate "Status" %}</th>
          <th>{% translate "Joined" %}</th>
          <th style="width: 260px;">{% translate "Actions" %}</th>
        </tr>
      </thead>

      <tbody>
        {% for u in page_obj.object_list %}
          <tr>
            <td>
              <div class="d-flex align-items-center gap-2">
                <div style="width:34px; height:34px; border-radius:50%; overflow:hidden; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04);">
                  {% if u.profile_picture %}
                    <img src="{{ u.profile_picture.url }}" alt="Avatar" style="width:100%; height:100%; object-fit:cover;">
                  {% endif %}
                </div>
                <div>
                  <div class="fw-semibold text-white">{{ u.first_name }} {{ u.last_name }}</div>
                  <div class="text-white-50 small">ID: {{ u.id }}{% if u.nickname %} • {{ u.nickname }}{% endif %}</div>
                </div>
              </div>
            </td>

            <td class="text-white-50">{{ u.email }}</td>
            <td class="text-white-50">{{ u.account_type|title }}</td>

            <td>
              {% if u.is_staff %}
                <span class="badge bg-info text-dark">{% translate "Staff" %}</span>
              {% else %}
                <span class="badge bg-secondary">{% translate "User" %}</span>
              {% endif %}
            </td>

            <td>
              {% if u.is_active %}
                <span class="badge bg-success">{% translate "Active" %}</span>
              {% else %}
                <span class="badge bg-danger">{% translate "Inactive" %}</span>
              {% endif %}
            </td>

            <td class="text-white-50 small">{{ u.date_joined|date:"d M Y" }}</td>

            <td>
              <div class="d-flex flex-wrap gap-2">
                <a class="btn btn-outline-light btn-sm"
                   href="{% url 'accounts:dash_crud_users_edit' u.id %}"
                   hx-get="{% url 'accounts:dash_crud_users_edit' u.id %}"
                   hx-target="#dashMainCard" hx-swap="innerHTML" hx-push-url="true">
                  {% translate "Edit" %}
                </a>

                <form method="post"
                      action="{% url 'accounts:dash_crud_users_toggle_active' u.id %}"
                      class="m-0"
                      hx-post="{% url 'accounts:dash_crud_users_toggle_active' u.id %}"
                      hx-target="#dashMainCard"
                      hx-swap="innerHTML"
                      hx-push-url="true">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-outline-warning btn-sm">
                    {% if u.is_active %}Deactivate{% else %}Activate{% endif %}
                  </button>
                </form>

                <form method="post"
                      action="{% url 'accounts:dash_crud_users_toggle_staff' u.id %}"
                      class="m-0"
                      hx-post="{% url 'accounts:dash_crud_users_toggle_staff' u.id %}"
                      hx-target="#dashMainCard"
                      hx-swap="innerHTML"
                      hx-push-url="true">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-outline-info btn-sm">
                    {% if u.is_staff %}Remove staff{% else %}Make staff{% endif %}
                  </button>
                </form>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="7" class="text-white-50">{% translate "No users found" %}.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if page_obj.paginator.num_pages > 1 %}
    <div class="d-flex align-items-center justify-content-between mt-3">
      <div class="text-white-50 small">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
      </div>

      <div class="d-flex gap-2">
        {% if page_obj.has_previous %}
          <a class="btn btn-outline-light btn-sm"
             href="?q={{ q }}&type={{ account_type }}&staff={{ staff }}&active={{ active }}&page={{ page_obj.previous_page_number }}"
             hx-get="?q={{ q }}&type={{ account_type }}&staff={{ staff }}&active={{ active }}&page={{ page_obj.previous_page_number }}"
             hx-target="#dashMainCard" hx-swap="innerHTML" hx-push-url="true">
            {% translate "Prev" %}
          </a>
        {% endif %}

        {% if page_obj.has_next %}
          <a class="btn btn-outline-light btn-sm"
             href="?q={{ q }}&type={{ account_type }}&staff={{ staff }}&active={{ active }}&page={{ page_obj.next_page_number }}"
             hx-get="?q={{ q }}&type={{ account_type }}&staff={{ staff }}&active={{ active }}&page={{ page_obj.next_page_number }}"
             hx-target="#dashMainCard" hx-swap="innerHTML" hx-push-url="true">
            {% translate "Next" %}
          </a>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>
